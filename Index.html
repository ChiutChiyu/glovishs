<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>GloVish - Blue Themed Social App</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: "Inter", sans-serif;
    }
    /* Scrollbar for chat and comments */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
  </style>
<style>
/* Desktop-friendly layout */
@media (min-width: 768px) {
  #public-profile {
    display: flex;
    gap: 2rem;
    justify-content: space-between;
    align-items: flex-start;
  }

  #profile-info, #follow-actions, #user-content-section, #private-chat-box {
    flex: 1;
  }

  #chat-messages {
    max-height: 300px;
  }

  #search-user-section {
    max-width: 400px;
  }
}
</style></head>
<body class="bg-gray-100 min-h-screen flex flex-col">
<header class="bg-white shadow-md sticky top-0 z-10">
<nav aria-label="Main navigation" class="max-w-4xl mx-auto flex items-center justify-between p-4" role="navigation">
<div class="text-2xl font-bold text-blue-600 flex items-center space-x-2">
<span>GloVish</span>
</div>
<ul class="hidden md:flex space-x-6 text-gray-700 font-semibold">
<li>
<button class="hover:text-blue-600" id="nav-feed">Feed</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-profile">Profile</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-private-chat" style="display:none;">Private Chat</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-leaderboard" style="display:none;">Leaderboard</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-upload">Upload</button>
</li>
</ul>
<div class="space-x-2" id="auth-buttons">
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" id="open-login-modal">
        Login
      </button>
<button class="bg-gray-200 text-blue-600 px-3 py-1 rounded hover:bg-gray-300" id="open-register-modal">
        Register
      </button>
</div>
<button class="ml-4 text-sm text-blue-600 hover:underline" id="toggle-theme">
      üåô Dark Mode
    </button>
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 hidden" id="logout-btn">
      Logout
    </button>
</nav>
</header>
<main class="flex-grow max-w-4xl mx-auto w-full p-4">
<!-- Login Page -->
<!-- Register Page -->
<!-- Profile Page -->
<section class="page hidden" id="profile-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Profile</h2>
<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md space-y-6">
<div class="flex flex-col items-center space-y-4">
<img alt="GloVish Default Profile" class="w-24 h-24 rounded-full object-cover border-2 border-blue-600" height="100" id="user-photo-display" src="https://i.imgur.com/qCjHhMH.png" width="100"/>
<h3 class="text-xl font-semibold text-gray-800" id="user-name-display"></h3>
<div class="flex space-x-6 mt-2">
<div class="text-center">
<div class="text-xl font-bold text-gray-800" id="following-count">0</div>
<div class="text-sm text-gray-500">Mengikuti</div>
</div>
<div class="text-center">
<div class="text-xl font-bold text-gray-800" id="followers-count">0</div>
<div class="text-sm text-gray-500">Pengikut</div>
</div>
</div></div>
<form class="space-y-4" id="profile-form">
<div>
<label class="block mb-1 font-medium text-gray-700" for="username">Change Username</label>
<input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="username" name="username" placeholder="New username" required="" type="text"/>
</div>
<div>
<label class="block mb-1 font-medium text-gray-700" for="photo">Change Profile Photo</label>
<input accept="image/*" class="w-full" id="photo" name="photo" type="file"/>
</div>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition" type="submit">
            Update Profile
          </button>
</form>
</div>
</section>
<!-- Feed Page -->
<section class="page hidden" id="feed-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Feed</h2>
<div class="max-w-md mx-auto mb-6">
<input aria-label="Search users" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-search-input" placeholder="Search users by username..." type="search"/>
<div aria-live="polite" aria-relevant="additions" class="bg-white rounded shadow mt-2 max-h-48 overflow-y-auto scrollbar-thin" id="user-search-results" role="listbox" tabindex="0">
<!-- Search results appear here -->
</div>
</div>
<div class="space-y-6" id="feed-container"></div>
</section>
<!-- Video Comments Page -->
<section class="page hidden" id="video-comments-page">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-4 flex flex-col h-[80vh]">
<header class="flex items-center justify-between border-b border-gray-300 pb-2 mb-4">
<h3 class="text-xl font-semibold" id="comment-video-title">Post Title</h3>
<button aria-label="Back to feed" class="text-blue-600 hover:text-red-800 focus:outline-none" id="comments-back-btn">
<i class="fas fa-times fa-lg"></i>
</button>
</header>
<div aria-live="polite" aria-relevant="additions" class="flex-grow overflow-y-auto scrollbar-thin" id="comments-list" tabindex="0">
<!-- Comments will be loaded here -->
</div>
<form aria-label="Add comment form" class="mt-4 flex space-x-2" id="comment-form">
<input aria-label="Add a comment" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="comment-input" placeholder="Add a comment..." required="" type="text"/>
<input id="comment-video-id" type="hidden"/>
<input id="comment-video-owner-id" type="hidden"/>
<button aria-label="Send comment" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" type="submit">
            Send
          </button>
</form>
</div>
</section>
<!-- Private Chat Page -->
<section class="page hidden" id="private-chat-page">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-4 flex flex-col h-[80vh]">
<header class="flex items-center justify-between border-b border-gray-300 pb-2 mb-4">
<h3 class="text-xl font-semibold" id="private-chat-title">Private Chats</h3>
<button aria-label="Back to feed" class="text-blue-600 hover:text-red-800 focus:outline-none" id="private-chat-back-btn" style="display:none;">
<i class="fas fa-arrow-left fa-lg"></i>
</button>
</header>
<div aria-live="polite" aria-relevant="additions" class="overflow-y-auto scrollbar-thin flex-grow space-y-2" id="private-chat-list" tabindex="0">
<div class="border-b border-gray-300 pb-4 mb-4" id="chat-history">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">Riwayat Chat</h3>
<ul class="space-y-2 max-h-40 overflow-y-auto scrollbar-thin" id="chat-history-list"></ul>
</div>
<label class="block font-semibold mb-1" for="private-chat-user-select">Start chat with:</label>
<div class="mb-4">
<input class="w-full px-3 py-2 border border-gray-300 rounded text-sm" id="user-search-input" placeholder="Cari pengguna..." type="text"/>
<ul class="mt-2 max-h-40 overflow-y-auto border border-gray-300 rounded text-sm bg-white dark:bg-gray-800 dark:text-white" id="user-search-results"></ul>
</div>
</div>
<div class="hidden flex flex-col flex-grow" id="private-chat-section">
<div class="text-sm text-gray-500 text-center mt-2 mb-2" id="chat-status"></div>
<div aria-live="polite" aria-relevant="additions" class="flex-grow overflow-y-auto scrollbar-thin p-2 border border-gray-300 rounded mb-4" id="private-chat-messages" style="min-height: 200px;" tabindex="0">
<!-- Messages will appear here -->
</div>
<form aria-label="Send private chat message form" class="flex space-x-2" id="private-chat-form">
<div class="flex space-x-2 mt-2">
<input accept="image/*" class="text-sm" id="chat-image-upload" type="file"/>
<img alt="Preview" class="w-16 h-16 object-cover rounded hidden" id="chat-image-preview" src="#"/>
</div>
<input aria-label="Type a message" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="private-chat-input" placeholder="Type a message..." required="" type="text"/>
<button aria-label="Send message" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" type="submit">
              Send
            </button>
</form>
</div>
</div>
</section>
<!-- Leaderboard Page -->
<section aria-label="Leaderboard" class="page hidden" id="leaderboard-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">
        Monthly Leaderboard
      </h2>
<div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-4 space-y-2" id="leaderboard-container">
<!-- Leaderboard entries will be loaded here -->
</div>
</section>
<section class="page hidden" id="upload-page"><h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Upload Media</h2>
<div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-8">
<div>
<h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Upload Video</h3>
<form class="space-y-4" id="upload-video-form">
<input accept="video/*" class="w-full" id="upload-video-input" required="" type="file"/>
<video class="w-full max-h-64 bg-black mb-4 hidden" controls="" id="upload-video-preview"></video>
<input class="w-full border px-3 py-2 rounded" id="upload-video-title" placeholder="Video Title" required="" type="text"/>
<textarea class="w-full border px-3 py-2 rounded" id="upload-video-desc" placeholder="Description (optional)" rows="3"></textarea>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Upload Video</button>
</form>
</div>
<div>
<h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Upload Photo</h3>
<form class="space-y-4" id="upload-photo-form">
<input accept="image/*" class="w-full" id="upload-photo-input" required="" type="file"/>
<img alt="Preview" class="w-full max-h-64 object-contain mb-4 hidden" id="upload-photo-preview"/>
<input class="w-full border px-3 py-2 rounded" id="upload-photo-title" placeholder="Photo Title" required="" type="text"/>
<textarea class="w-full border px-3 py-2 rounded" id="upload-photo-desc" placeholder="Description (optional)" rows="3"></textarea>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Upload Photo</button>
</form>
</div>
</div>
</section></main>
<!-- Android-like bottom navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 flex justify-around items-center h-16 md:hidden z-20" id="bottom-nav">
<button aria-label="Feed" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="feed-page">
<i class="fas fa-home fa-lg"></i>
<span class="text-xs mt-1">Feed</span>
</button>
<button aria-label="Upload" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="upload-page">
<i class="fas fa-upload fa-lg"></i>
<span class="text-xs mt-1">Upload</span>
</button>
<button aria-label="Profile" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="profile-page">
<i class="fas fa-user fa-lg"></i>
<span class="text-xs mt-1">Profile</span>
</button>
<button aria-label="Private Chat" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="private-chat-page">
<i class="fas fa-comments fa-lg"></i>
<span class="text-xs mt-1">Chat</span>
</button>
<button aria-label="Leaderboard" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="leaderboard-page">
<i class="fas fa-trophy fa-lg"></i>
<span class="text-xs mt-1">Leaderboard</span>
</button>
</nav>
<!-- Login Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="login-modal">
<div class="bg-white p-6 rounded shadow-lg w-96">
<h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
<form class="space-y-4" id="login-form">
<input class="w-full border px-3 py-2 rounded" name="email" placeholder="Email" required="" type="email"/>
<input class="w-full border px-3 py-2 rounded" name="password" placeholder="Password" required="" type="password"/>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Login</button>
<p class="text-sm text-center text-gray-600">Belum punya akun? <button class="text-blue-600 hover:underline" id="switch-to-register" type="button">Daftar</button></p>
</form>
</div>
</div>
<!-- Register Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="register-modal">
<div class="bg-white p-6 rounded shadow-lg w-96">
<h2 class="text-xl font-semibold mb-4 text-center">Register</h2>
<form class="space-y-4" id="register-form">
<input class="w-full border px-3 py-2 rounded" name="username" placeholder="Username" required="" type="text"/>
<input class="w-full border px-3 py-2 rounded" name="email" placeholder="Email" required="" type="email"/>
<input class="w-full border px-3 py-2 rounded" name="password" placeholder="Password" required="" type="password"/>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Register</button>
<p class="text-sm text-center text-gray-600">Sudah punya akun? <button class="text-blue-600 hover:underline" id="switch-to-login" type="button">Login</button></p>
</form>
</div>
</div>
<script>
  const loginModal = document.getElementById("login-modal");
  const registerModal = document.getElementById("register-modal");

  document.getElementById("open-login-modal")?.addEventListener("click", () => {
    loginModal.classList.remove("hidden");
  });

  document.getElementById("open-register-modal")?.addEventListener("click", () => {
    registerModal.classList.remove("hidden");
  });

  document.getElementById("switch-to-register")?.addEventListener("click", () => {
    loginModal.classList.add("hidden");
    registerModal.classList.remove("hidden");
  });

  document.getElementById("switch-to-login")?.addEventListener("click", () => {
    registerModal.classList.add("hidden");
    loginModal.classList.remove("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === loginModal) loginModal.classList.add("hidden");
    if (e.target === registerModal) registerModal.classList.add("hidden");
  });
</script>
<script>
document.getElementById("nav-upload")?.addEventListener("click", () => showPage("upload-page"));
</script><script>
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const followingRef = dbRef(database, "following/" + user.uid);
    const followersRef = dbRef(database, "followers/" + user.uid);

    try {
      const [followingSnap, followersSnap] = await Promise.all([
        get(followingRef),
        get(followersRef),
      ]);

      const followingCount = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;
      const followersCount = followersSnap.exists() ? Object.keys(followersSnap.val()).length : 0;

      document.getElementById("following-count").textContent = followingCount;
      document.getElementById("followers-count").textContent = followersCount;
    } catch (err) {
      console.error("Error fetching follower data:", err);
    }
  }
});
</script><style>
.dark {
  background-color: #1a202c;
  color: #edf2f7;
}
.dark input,
.dark textarea,
.dark select {
  background-color: #2d3748;
  color: #edf2f7;
  border-color: #4a5568;
}
.dark .bg-white {
  background-color: #2d3748 !important;
}
.dark .text-gray-700,
.dark .text-gray-500,
.dark .text-gray-600 {
  color: #cbd5e0 !important;
}
.dark .border-gray-300 {
  border-color: #4a5568 !important;
}
</style><script>
document.getElementById("toggle-theme")?.addEventListener("click", () => {
  const body = document.body;
  const btn = document.getElementById("toggle-theme");
  const dark = body.classList.toggle("dark");

  if (dark) {
    btn.textContent = "‚òÄÔ∏è Light Mode";
    localStorage.setItem("theme", "dark");
  } else {
    btn.textContent = "üåô Dark Mode";
    localStorage.setItem("theme", "light");
  }
});

// Apply theme on load
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    const btn = document.getElementById("toggle-theme");
    if (btn) btn.textContent = "‚òÄÔ∏è Light Mode";
  }
});
</script><script>
// Preview video
uploadVideoInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    uploadVideoPreview.src = URL.createObjectURL(file);
    uploadVideoPreview.classList.remove("hidden");
  } else {
    uploadVideoPreview.classList.add("hidden");
  }
});

// Preview photo
uploadPhotoInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    uploadPhotoPreview.src = URL.createObjectURL(file);
    uploadPhotoPreview.classList.remove("hidden");
  } else {
    uploadPhotoPreview.classList.add("hidden");
  }
});
</script><script>
onAuthStateChanged(auth, (user) => {
  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) {
    logoutBtn.style.display = user ? "inline-block" : "none";
  }
});

document.getElementById("logout-btn")?.addEventListener("click", async () => {
  try {
    await signOut(auth);
    alert("You have been logged out.");
  } catch (err) {
    alert("Logout failed: " + err.message);
  }
});
</script><script>
function getChatRoomId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
}

let currentChatRoomId = null;
let chatMessagesListener = null;

document.getElementById("private-chat-user-select")?.addEventListener("change", async (e) => {
  const otherUserId = e.target.value;
  const user = auth.currentUser;
  if (!user || !otherUserId) return;

  currentChatRoomId = getChatRoomId(user.uid, otherUserId);
  loadPrivateMessages(currentChatRoomId);
});

function loadPrivateMessages(chatRoomId) {
  const messagesRef = dbRef(database, "privateChats/" + chatRoomId);
  const messagesContainer = document.getElementById("private-chat-messages");
  messagesContainer.innerHTML = "<p class='text-center text-gray-500'>Loading messages...</p>";

  if (chatMessagesListener) chatMessagesListener();

  chatMessagesListener = onValue(messagesRef, (snapshot) => {
    messagesContainer.innerHTML = "";
    if (snapshot.exists()) {
      const messages = Object.values(snapshot.val()).sort((a, b) => a.timestamp - b.timestamp);
      messages.forEach(msg => {
        const isSelf = msg.uid === auth.currentUser.uid;
        const msgEl = document.createElement("div");
        msgEl.className = "mb-2 flex " + (isSelf ? "justify-end" : "justify-start");
        msgEl.innerHTML = `
          <div class="px-4 py-2 rounded-lg max-w-xs break-words ${
            isSelf ? "bg-blue-600 text-white" : "bg-gray-300 text-black"
          }">
            <p class="text-sm">${msg.text}</p>
            <p class="text-xs mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString()}</p>
          </div>
        `;
        messagesContainer.appendChild(msgEl);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else {
      messagesContainer.innerHTML = "<p class='text-center text-gray-500'>No messages yet.</p>";
    }
  });
}

document.getElementById("private-chat-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("private-chat-input");
  const text = input.value.trim();
  const user = auth.currentUser;
  if (!text || !user || !currentChatRoomId) return;

  const msgData = {
    uid: user.uid,
    text: text,
    timestamp: Date.now()
  };

  try {
    const newMsgRef = push(dbRef(database, "privateChats/" + currentChatRoomId));
    await set(newMsgRef, msgData);
    input.value = "";
  } catch (err) {
    alert("Failed to send message: " + err.message);
  }
});
</script><script>
let typingTimeout = null;
const typingRef = ref(database, "typingStatus");
const user = auth.currentUser;

// Detect typing
document.getElementById("private-chat-input")?.addEventListener("input", () => {
  const otherId = currentChatOtherUserId;
  if (!auth.currentUser || !currentChatRoomId || !otherId) return;
  const statusRef = dbRef(database, "typingStatus/" + otherId + "/" + auth.currentUser.uid);
  set(statusRef, true);
  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    set(statusRef, false);
  }, 2000);
});

// Listen to typing status of other user
function listenToTypingStatus(otherUserId) {
  const statusRef = dbRef(database, "typingStatus/" + auth.currentUser.uid + "/" + otherUserId);
  onValue(statusRef, (snapshot) => {
    const chatStatus = document.getElementById("chat-status");
    if (snapshot.exists() && snapshot.val() === true) {
      chatStatus.textContent = "Sedang mengetik...";
    } else {
      chatStatus.textContent = "";
    }
  });
}

// Track online status
onAuthStateChanged(auth, (user) => {
  if (user) {
    const statusRef = dbRef(database, "onlineStatus/" + user.uid);
    set(statusRef, true);
    window.addEventListener("beforeunload", () => {
      set(statusRef, false);
    });
  }
});

// Show online status
function showOnlineStatus(otherUserId) {
  const chatStatus = document.getElementById("chat-status");
  const statusRef = dbRef(database, "onlineStatus/" + otherUserId);
  onValue(statusRef, (snapshot) => {
    if (snapshot.exists() && snapshot.val() === true) {
      chatStatus.textContent = "Pengguna sedang online";
    } else {
      chatStatus.textContent = "Pengguna sedang offline";
    }
  });
}

// Update when chat room selected
function updateChatStatus(otherUserId) {
  showOnlineStatus(otherUserId);
  listenToTypingStatus(otherUserId);
}
</script><script>
document.getElementById("private-chat-user-select")?.addEventListener("change", (e) => {
  const otherUserId = e.target.value;
  if (otherUserId) updateChatStatus(otherUserId);
});
</script><script>
// Notifikasi suara
const notifSound = new Audio("https://www.myinstants.com/media/sounds/pop-up-off.mp3");

function loadPrivateMessages(chatRoomId) {
  const messagesRef = dbRef(database, "privateChats/" + chatRoomId);
  const messagesContainer = document.getElementById("private-chat-messages");
  messagesContainer.innerHTML = "<p class='text-center text-gray-500'>Loading messages...</p>";

  if (chatMessagesListener) chatMessagesListener();

  let lastMessageCount = 0;

  chatMessagesListener = onValue(messagesRef, (snapshot) => {
    messagesContainer.innerHTML = "";
    if (snapshot.exists()) {
      const messages = Object.entries(snapshot.val()).sort((a, b) => a[1].timestamp - b[1].timestamp);
      const currentCount = messages.length;

      messages.forEach(([key, msg]) => {
        const isSelf = msg.uid === auth.currentUser.uid;
        const msgEl = document.createElement("div");
        msgEl.className = "mb-2 flex " + (isSelf ? "justify-end" : "justify-start");
        msgEl.innerHTML = `
          <div class="px-4 py-2 rounded-lg max-w-xs break-words ${
            isSelf ? "bg-blue-600 text-white" : "bg-gray-300 text-black"
          }">
            <p class="text-sm">${msg.text}</p>
            <p class="text-xs mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString()}</p>
          </div>
        `;
        messagesContainer.appendChild(msgEl);

        // Tandai sebagai dibaca jika bukan pesan sendiri
        if (!isSelf) {
          set(dbRef(database, "privateChats/" + chatRoomId + "/" + key + "/read"), true);
        }
      });

      if (currentCount > lastMessageCount && currentCount > 0) {
        const latest = messages[messages.length - 1][1];
        if (latest.uid !== auth.currentUser.uid && !latest.read) {
          notifSound.play().catch(() => {});
        }
      }

      lastMessageCount = currentCount;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else {
      messagesContainer.innerHTML = "<p class='text-center text-gray-500'>No messages yet.</p>";
    }
  });
}
</script><script>
const imageInput = document.getElementById("chat-image-upload");
const preview = document.getElementById("chat-image-preview");

imageInput?.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  } else {
    preview.classList.add("hidden");
  }
});

document.getElementById("private-chat-form")?.addEventListener("submit", async (e) => {
  const imageFile = imageInput.files[0];
  if (imageFile) {
    const user = auth.currentUser;
    if (!user || !currentChatRoomId) return;

    const storageRef = ref(storage, "chat_images/" + currentChatRoomId + "/" + Date.now() + "_" + imageFile.name);
    const snapshot = await uploadBytes(storageRef, imageFile);
    const downloadURL = await getDownloadURL(snapshot.ref);

    const msgData = {
      uid: user.uid,
      imageUrl: downloadURL,
      timestamp: Date.now()
    };

    const newMsgRef = push(dbRef(database, "privateChats/" + currentChatRoomId));
    await set(newMsgRef, msgData);

    preview.classList.add("hidden");
    imageInput.value = "";
  }
});
</script><script>
function renderMessage(msg) {
  const isSelf = msg.uid === auth.currentUser.uid;
  const msgEl = document.createElement("div");
  msgEl.className = "mb-2 flex " + (isSelf ? "justify-end" : "justify-start");
  let content = "";

  if (msg.imageUrl) {
    content = \`
      <img src="\${msg.imageUrl}" class="max-w-xs max-h-60 rounded" />
    \`;
  } else {
    content = \`
      <p class="text-sm">\${msg.text}</p>
    \`;
  }

  msgEl.innerHTML = \`
    <div class="px-4 py-2 rounded-lg max-w-xs break-words \${isSelf ? "bg-blue-600 text-white" : "bg-gray-300 text-black"}">
      \${content}
      <p class="text-xs mt-1 text-right">\${new Date(msg.timestamp).toLocaleTimeString()}</p>
    </div>
  \`;
  return msgEl;
}
</script><script>
function renderMessage(msg) {
  const isSelf = msg.uid === auth.currentUser.uid;
  const msgEl = document.createElement("div");
  msgEl.className = "mb-2 flex " + (isSelf ? "justify-end" : "justify-start");

  let content = "";
  if (msg.imageUrl) {
    content = \`<img src="\${msg.imageUrl}" class="max-w-xs max-h-60 rounded" />\`;
  } else {
    content = \`<p class="text-sm">\${msg.text}</p>\`;
  }

  let status = "";
  if (isSelf) {
    if (msg.read === true) {
      status = "‚úî‚úî";
    } else {
      status = "‚úî";
    }
  }

  msgEl.innerHTML = \`
    <div class="px-4 py-2 rounded-lg max-w-xs break-words \${isSelf ? "bg-blue-600 text-white" : "bg-gray-300 text-black"}">
      \${content}
      <div class="flex justify-between text-xs mt-1">
        <span class="text-right">\${new Date(msg.timestamp).toLocaleTimeString()}</span>
        \${status ? '<span class="ml-2">' + status + '</span>' : ''}
      </div>
    </div>
  \`;
  return msgEl;
}
</script><script>
function renderMessage(msg, key) {
  const isSelf = msg.uid === auth.currentUser.uid;
  const msgEl = document.createElement("div");
  msgEl.className = "mb-2 flex " + (isSelf ? "justify-end" : "justify-start");

  let content = "";
  if (msg.deleted) {
    content = '<p class="italic text-gray-500">Pesan ini dihapus (ups)</p>';
  } else if (msg.imageUrl) {
    content = \`<img src="\${msg.imageUrl}" class="max-w-xs max-h-60 rounded" />\`;
  } else {
    content = \`<p class="text-sm">\${msg.text}</p>\`;
  }

  let status = "";
  if (isSelf && !msg.deleted) {
    if (msg.read === true) {
      status = "‚úî‚úî";
    } else {
      status = "‚úî";
    }
  }

  msgEl.innerHTML = \`
    <div class="relative group px-4 py-2 rounded-lg max-w-xs break-words \${isSelf ? "bg-blue-600 text-white" : "bg-gray-300 text-black"}">
      \${content}
      <div class="flex justify-between text-xs mt-1">
        <span class="text-right">\${new Date(msg.timestamp).toLocaleTimeString()}</span>
        \${status ? '<span class="ml-2">' + status + '</span>' : ''}
      </div>
      \${isSelf && !msg.deleted ? '<button onclick="deleteMessage(\'' + key + '\')" class="absolute top-0 right-0 text-xs text-red-500 hidden group-hover:block bg-white dark:bg-gray-800 px-1 rounded">üóëÔ∏è</button>' : ''}
    </div>
  \`;
  return msgEl;
}

// Fungsi hapus pesan (tandai sebagai deleted)
function deleteMessage(key) {
  if (!auth.currentUser || !currentChatRoomId || !key) return;
  const msgRef = dbRef(database, "privateChats/" + currentChatRoomId + "/" + key);
  update(msgRef, {
    deleted: true,
    text: "",
    imageUrl: null
  });
}
</script>
<section class="p-4 hidden" id="group-chat-page">
<div class="hidden mb-4 bg-yellow-50 dark:bg-yellow-900 p-3 rounded border border-yellow-300 dark:border-yellow-600" id="pinned-messages">
<h4 class="font-semibold text-yellow-700 dark:text-yellow-200 mb-2">üìå Pesan yang Dipin</h4>
<ul class="space-y-1 text-sm text-gray-800 dark:text-white" id="pinned-message-list"></ul>
</div>
<h2 class="text-2xl font-bold mb-4 text-center text-gray-700 dark:text-white">Group Chat</h2>
<div class="hidden mb-4" id="edit-group-section">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">Edit Grup</h3>
<input class="w-full px-3 py-2 border border-gray-300 rounded mb-2" id="edit-group-name" placeholder="Nama Baru Grup" type="text"/>
<input accept="image/*" class="text-sm mb-2" id="edit-group-image" type="file"/>
<img class="w-16 h-16 rounded hidden mb-2" id="edit-group-preview" src="#"/>
<button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full" id="save-group-edit">
    Simpan Perubahan
  </button>
</div>
<div class="hidden mb-4" id="group-admin-tools">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">Kelola Anggota</h3>
<ul class="space-y-1 max-h-40 overflow-y-auto border p-2 rounded bg-white dark:bg-gray-800 text-sm" id="group-member-list"></ul>
<button class="mt-3 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 w-full" id="delete-group-btn">
    Hapus Grup
  </button>
</div>
<div class="mb-4">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">Grup Saya</h3>
<ul class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 p-2 rounded bg-white dark:bg-gray-800 text-sm" id="user-group-list"></ul>
<div class="flex items-center space-x-2 mt-2">
<input accept="image/*" class="text-sm" id="group-image-upload" type="file"/>
<img alt="Preview" class="w-16 h-16 rounded hidden" id="group-image-preview" src="#"/>
</div>
</div>
<div class="max-w-xl mx-auto">
<div class="mb-4">
<input class="w-full px-3 py-2 border border-gray-300 rounded" id="group-name-input" placeholder="Nama Grup" type="text"/>
<button class="mt-2 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" id="create-group-btn">
        Buat Grup
      </button>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 dark:text-white mb-1">Pilih Anggota:</label>
<ul class="space-y-1 max-h-48 overflow-y-auto border p-2 rounded bg-white dark:bg-gray-800 text-sm" id="group-user-list"></ul>
</div>
<div class="hidden" id="group-chat-area">
<div class="border rounded p-4 max-h-64 overflow-y-auto mb-4 bg-white dark:bg-gray-900" id="group-messages"></div>
<form class="flex gap-2" id="group-chat-form">
<input class="flex-1 px-3 py-2 border rounded" id="group-chat-input" placeholder="Ketik pesan..." type="text"/>
<button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" type="submit">Kirim</button>
</form>
</div>
</div>
</section>
<script>
let currentGroupId = null;

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const usersSnap = await get(dbRef(database, "users"));
    if (usersSnap.exists()) {
      const userList = document.getElementById("group-user-list");
      userList.innerHTML = "";
      const users = usersSnap.val();
      for (const uid in users) {
        if (uid === user.uid) continue;
        const li = document.createElement("li");
        li.innerHTML = \`
          <label class="flex items-center space-x-2">
            <input type="checkbox" value="\${uid}" class="group-user-checkbox" />
            <span>\${users[uid].username || users[uid].email}</span>
          </label>
        \`;
        userList.appendChild(li);
      }
    }
  }
});

document.getElementById("create-group-btn")?.addEventListener("click", async () => {
  const name = document.getElementById("group-name-input").value.trim();
  const user = auth.currentUser;
  const members = Array.from(document.querySelectorAll(".group-user-checkbox"))
    .filter(c => c.checked)
    .map(c => c.value);
  if (!name || members.length === 0 || !user) return alert("Lengkapi data grup!");

  members.push(user.uid);
  const groupId = push(dbRef(database, "groups")).key;
  await set(dbRef(database, "groups/" + groupId), {
    name: name,
    members: members,
    createdAt: Date.now()
  });
  currentGroupId = groupId;
  document.getElementById("group-chat-area").classList.remove("hidden");
  loadGroupMessages(groupId);
});

function loadGroupMessages(groupId) {
  const msgRef = dbRef(database, "groupMessages/" + groupId);
  const box = document.getElementById("group-messages");
  onValue(msgRef, (snap) => {
    box.innerHTML = "";
    if (snap.exists()) {
      Object.values(snap.val()).forEach((msg) => {
        const div = document.createElement("div");
        div.className = "mb-2";
        div.innerHTML = \`
          <span class="font-semibold text-sm">\${msg.sender}</span>:
          <span class="text-sm">\${msg.text}</span>
          <span class="text-xs text-gray-500 float-right">\${new Date(msg.timestamp).toLocaleTimeString()}</span>
        \`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
  });
}

document.getElementById("group-chat-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("group-chat-input");
  const text = input.value.trim();
  const user = auth.currentUser;
  if (!text || !user || !currentGroupId) return;
  const msgData = {
    sender: user.email || user.uid,
    text,
    timestamp: Date.now()
  };
  const newMsgRef = push(dbRef(database, "groupMessages/" + currentGroupId));
  await set(newMsgRef, msgData);
  input.value = "";
});
</script><script>
// Preview gambar grup
document.getElementById("group-image-upload")?.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const preview = document.getElementById("group-image-preview");
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  }
});

// Ambil grup yang diikuti pengguna
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const snap = await get(dbRef(database, "groups"));
    const groupList = document.getElementById("user-group-list");
    groupList.innerHTML = "";
    if (snap.exists()) {
      const all = snap.val();
      Object.entries(all).forEach(([gid, g]) => {
        if (g.members.includes(user.uid)) {
          const li = document.createElement("li");
          li.className = "cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 px-2 py-1 rounded";
          li.textContent = g.name;
          li.onclick = () => {
            currentGroupId = gid;
            document.getElementById("group-chat-area").classList.remove("hidden");
            loadGroupMessages(gid);
          };
          groupList.appendChild(li);
        }
      });
    }
  }
});

// Override pembuatan grup agar bisa simpan gambar
document.getElementById("create-group-btn")?.addEventListener("click", async () => {
  const name = document.getElementById("group-name-input").value.trim();
  const user = auth.currentUser;
  const members = Array.from(document.querySelectorAll(".group-user-checkbox"))
    .filter(c => c.checked).map(c => c.value);
  const imgFile = document.getElementById("group-image-upload").files[0];

  if (!name || members.length === 0 || !user) return alert("Lengkapi data grup!");
  members.push(user.uid);

  const groupId = push(dbRef(database, "groups")).key;
  const groupData = {
    name: name,
    members: members,
    createdAt: Date.now()
  };

  if (imgFile) {
    const storageRef = ref(storage, "group_images/" + groupId + "_" + imgFile.name);
    const upload = await uploadBytes(storageRef, imgFile);
    const downloadURL = await getDownloadURL(upload.ref);
    groupData.image = downloadURL;
  }

  await set(dbRef(database, "groups/" + groupId), groupData);
  currentGroupId = groupId;
  document.getElementById("group-chat-area").classList.remove("hidden");
  loadGroupMessages(groupId);
});
</script><script>
document.getElementById("edit-group-image")?.addEventListener("change", (e) => {
  const file = e.target.files[0];
  const preview = document.getElementById("edit-group-preview");
  if (file) {
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  } else {
    preview.classList.add("hidden");
  }
});

// Buka form edit saat grup dipilih
function openEditGroupForm(groupData) {
  document.getElementById("edit-group-section").classList.remove("hidden");
  document.getElementById("edit-group-name").value = groupData.name;
}

document.getElementById("save-group-edit")?.addEventListener("click", async () => {
  const nameInput = document.getElementById("edit-group-name").value.trim();
  const imgFile = document.getElementById("edit-group-image").files[0];
  const user = auth.currentUser;
  if (!user || !currentGroupId) return;

  const updates = { name: nameInput };
  if (imgFile) {
    const storageRef = ref(storage, "group_images/" + currentGroupId + "_" + imgFile.name);
    const upload = await uploadBytes(storageRef, imgFile);
    const downloadURL = await getDownloadURL(upload.ref);
    updates.image = downloadURL;
  }

  await update(dbRef(database, "groups/" + currentGroupId), updates);
  alert("Perubahan grup berhasil disimpan.");
});
</script><script>
function loadGroupMembers(groupId) {
  get(dbRef(database, "groups/" + groupId)).then(snapshot => {
    if (!snapshot.exists()) return;
    const group = snapshot.val();
    const list = document.getElementById("group-member-list");
    list.innerHTML = "";
    document.getElementById("group-admin-tools").classList.remove("hidden");
    document.getElementById("edit-group-section").classList.remove("hidden");

    group.members.forEach(uid => {
      get(dbRef(database, "users/" + uid)).then(userSnap => {
        const user = userSnap.val();
        const li = document.createElement("li");
        li.className = "flex items-center justify-between";
        li.innerHTML = \`
          <span>\${user?.username || user?.email || "User"}</span>
          <button class="text-red-500 text-xs" onclick="removeMemberFromGroup('\${groupId}', '\${uid}')">Keluarkan</button>
        \`;
        list.appendChild(li);
      });
    });
  });
}

function removeMemberFromGroup(groupId, uid) {
  get(dbRef(database, "groups/" + groupId)).then(snapshot => {
    if (!snapshot.exists()) return;
    const group = snapshot.val();
    const updated = group.members.filter(id => id !== uid);
    update(dbRef(database, "groups/" + groupId), { members: updated });
    loadGroupMembers(groupId);
  });
}

document.getElementById("delete-group-btn")?.addEventListener("click", async () => {
  if (!confirm("Yakin ingin menghapus grup ini secara permanen?")) return;
  if (currentGroupId) {
    await remove(dbRef(database, "groups/" + currentGroupId));
    await remove(dbRef(database, "groupMessages/" + currentGroupId));
    alert("Grup telah dihapus.");
    location.reload();
  }
});

// Pin pesan dalam grup
function loadGroupMessages(groupId) {
  const msgRef = dbRef(database, "groupMessages/" + groupId);
  const box = document.getElementById("group-messages");
  onValue(msgRef, (snap) => {
    box.innerHTML = "";
    if (snap.exists()) {
      const messages = Object.entries(snap.val());
      messages.forEach(([key, msg]) => {
        const div = document.createElement("div");
        div.className = "mb-2 relative group";
        div.innerHTML = \`
          <span class="font-semibold text-sm">\${msg.sender}</span>:
          <span class="text-sm">\${msg.text}</span>
          <span class="text-xs text-gray-500 float-right">\${new Date(msg.timestamp).toLocaleTimeString()}</span>
          <button class="absolute right-0 top-0 text-xs hidden group-hover:block text-yellow-500 bg-white dark:bg-gray-800 px-1 rounded"
            onclick="pinGroupMessage('\${groupId}', '\${key}')">üìå</button>
        \`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
  });
}

function pinGroupMessage(groupId, msgKey) {
  update(dbRef(database, "groupMessages/" + groupId + "/" + msgKey), {
    pinned: true
  });
  alert("Pesan dipin.");
}
</script><script>
function loadPinnedMessages(groupId) {
  const pinBox = document.getElementById("pinned-messages");
  const pinList = document.getElementById("pinned-message-list");
  const refPin = dbRef(database, "groupMessages/" + groupId);

  onValue(refPin, (snap) => {
    pinList.innerHTML = "";
    let hasPinned = false;

    if (snap.exists()) {
      Object.values(snap.val()).forEach(msg => {
        if (msg.pinned) {
          hasPinned = true;
          const li = document.createElement("li");
          li.textContent = msg.text;
          pinList.appendChild(li);
        }
      });
    }

    pinBox.classList.toggle("hidden", !hasPinned);
  });
}

// Tambahkan pemanggilan saat grup dipilih
function loadGroupMessages(groupId) {
  const msgRef = dbRef(database, "groupMessages/" + groupId);
  const box = document.getElementById("group-messages");
  onValue(msgRef, (snap) => {
    box.innerHTML = "";
    if (snap.exists()) {
      const messages = Object.entries(snap.val());
      messages.forEach(([key, msg]) => {
        const div = document.createElement("div");
        div.className = "mb-2 relative group";
        div.innerHTML = \`
          <span class="font-semibold text-sm">\${msg.sender}</span>:
          <span class="text-sm">\${msg.text}</span>
          <span class="text-xs text-gray-500 float-right">\${new Date(msg.timestamp).toLocaleTimeString()}</span>
          <button class="absolute right-0 top-0 text-xs hidden group-hover:block text-yellow-500 bg-white dark:bg-gray-800 px-1 rounded"
            onclick="pinGroupMessage('\${groupId}', '\${key}')">üìå</button>
        \`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
  });

  loadPinnedMessages(groupId);
}
</script>
<section class="hidden p-4 bg-white dark:bg-gray-900 rounded border mt-4" id="admin-panel">
<h2 class="text-xl font-bold mb-3 text-red-600">üîê Panel Admin</h2>
<ul class="space-y-2 text-sm max-h-64 overflow-y-auto" id="user-ban-list"></ul>
<div class="mt-4" id="broadcast-panel">
<h3 class="font-semibold text-gray-700 dark:text-white mb-2">üì¢ Kirim Pesan ke Semua Pengguna</h3>
<textarea class="w-full border px-2 py-1 rounded mb-2 text-sm" id="broadcast-message" rows="3"></textarea>
<button class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded w-full" id="broadcast-send">Kirim Broadcast</button>
</div>
<div class="mt-4" id="role-management">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">üõ°Ô∏è Manajemen Peran</h3>
<ul class="space-y-2 text-sm max-h-64 overflow-y-auto border p-2 rounded bg-white dark:bg-gray-800" id="user-role-list"></ul>
</div>
</section>
<script>
const ADMIN_EMAIL = "alarifkyhp@gmail.com";

onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  if (user.email === ADMIN_EMAIL) {
    document.getElementById("admin-panel").classList.remove("hidden");
    loadUsersForBan();
  }
});

// Tampilkan semua user kecuali admin sendiri
async function loadUsersForBan() {
  const snap = await get(dbRef(database, "users"));
  const list = document.getElementById("user-ban-list");
  list.innerHTML = "";
  if (!snap.exists()) return;
  const users = snap.val();
  Object.entries(users).forEach(([uid, data]) => {
    if (data.email === ADMIN_EMAIL) return;
    const li = document.createElement("li");
    li.className = "flex items-center justify-between border-b py-2";
    li.innerHTML = \`
      <span>\${data.username || data.email}</span>
      <button class="text-white bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs"
        onclick="banUser('\${uid}')">Ban</button>
    \`;
    list.appendChild(li);
  });
}

// Tandai user sebagai diban di database
function banUser(uid) {
  update(dbRef(database, "users/" + uid), { banned: true });
  alert("User telah dibanned.");
}

// Cegah login jika dibanned
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  const snap = await get(dbRef(database, "users/" + user.uid));
  if (snap.exists() && snap.val().banned === true) {
    alert("Akun Anda telah dibanned oleh admin.");
    await signOut(auth);
    location.reload();
  }
});
</script><script>
// Perbarui loadUsersForBan agar tampilkan ban/unban
async function loadUsersForBan() {
  const snap = await get(dbRef(database, "users"));
  const list = document.getElementById("user-ban-list");
  list.innerHTML = "";
  if (!snap.exists()) return;
  const users = snap.val();

  Object.entries(users).forEach(([uid, data]) => {
    if (data.email === ADMIN_EMAIL) return;
    const isBanned = data.banned === true;
    const li = document.createElement("li");
    li.className = "flex items-center justify-between border-b py-2";
    li.innerHTML = \`
      <span>\${data.username || data.email}</span>
      <button class="text-white \${isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} px-2 py-1 rounded text-xs"
        onclick="\${isBanned ? 'unbanUser' : 'banUser'}('\${uid}')">\${isBanned ? 'Unban' : 'Ban'}</button>
    \`;
    list.appendChild(li);
  });
}

// Fungsi unban
function unbanUser(uid) {
  update(dbRef(database, "users/" + uid), { banned: false });
  alert("User telah di-unban.");
  loadUsersForBan();
}

// Fungsi broadcast pesan ke semua pengguna
document.getElementById("broadcast-send")?.addEventListener("click", async () => {
  const msg = document.getElementById("broadcast-message").value.trim();
  if (!msg) return alert("Isi pesan tidak boleh kosong!");
  const ref = dbRef(database, "broadcasts");
  const newMsg = push(ref);
  await set(newMsg, {
    message: msg,
    timestamp: Date.now()
  });
  alert("Pesan broadcast terkirim!");
  document.getElementById("broadcast-message").value = "";
});
</script><script>
async function loadUsersForBan() {
  const snap = await get(dbRef(database, "users"));
  const list = document.getElementById("user-ban-list");
  list.innerHTML = "";
  if (!snap.exists()) return;
  const users = snap.val();

  Object.entries(users).forEach(([uid, data]) => {
    const isOwner = data.email === ADMIN_EMAIL;
    const isBanned = data.banned === true;
    const label = isOwner ? '<span class="ml-2 text-red-600 font-semibold text-xs">[Owner]</span>' : '';
    const li = document.createElement("li");
    li.className = "flex items-center justify-between border-b py-2";
    if (!isOwner) {
      li.innerHTML = \`
        <span>\${data.username || data.email}\${label}</span>
        <button class="text-white \${isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} px-2 py-1 rounded text-xs"
          onclick="\${isBanned ? 'unbanUser' : 'banUser'}('\${uid}')">\${isBanned ? 'Unban' : 'Ban'}</button>
      \`;
    } else {
      li.innerHTML = \`
        <span>\${data.username || data.email}\${label}</span>
        <span class="text-gray-400 text-xs">--</span>
      \`;
    }
    list.appendChild(li);
  });
}
</script>
<section class="hidden mt-4 bg-white dark:bg-gray-900 p-4 border rounded" id="public-profile">
<h2 class="text-xl font-bold mb-3">üë§ Profil Pengguna</h2>
<div class="mb-2 text-sm" id="profile-info">
<p><strong>Username:</strong> <span id="public-username"></span></p>
<p><strong>Email:</strong> <span id="public-email"></span></p>
<p><strong>Diikuti:</strong> <span id="public-following-count">0</span></p>
<p><strong>Pengikut:</strong> <span id="public-followers-count">0</span></p>
</div>
<div class="mt-2" id="follow-actions">
<button class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700" id="follow-button"></button>
</div>
<div class="mt-4 hidden" id="user-content-section">
<h3 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">üì∏ Konten Pengguna</h3>
<div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="user-content-list"></div>
</div>
<div class="mt-6 hidden border-t pt-4" id="private-chat-box">
<h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">üí¨ Chat Privat</h3>
<div class="max-h-60 overflow-y-auto mb-2 p-2 border rounded bg-white dark:bg-gray-800 text-sm" id="chat-messages"></div>
<div class="flex gap-2">
<input class="flex-grow px-2 py-1 border rounded text-sm" id="chat-input" placeholder="Ketik pesan..." type="text"/>
<button class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700" id="chat-send-btn">Kirim</button>
</div>
</div>
</section>
<script>
// Fungsi untuk memuat profil publik berdasarkan UID
async function viewUserProfile(uid) {
  const profileSection = document.getElementById("public-profile");
  const usernameSpan = document.getElementById("public-username");
  const emailSpan = document.getElementById("public-email");
  const followingSpan = document.getElementById("public-following-count");
  const followersSpan = document.getElementById("public-followers-count");

  try {
    const snap = await get(dbRef(database, "users/" + uid));
    if (!snap.exists()) {
      alert("Pengguna tidak ditemukan.");
      return;
    }

    const data = snap.val();
    usernameSpan.textContent = data.username || "Tidak tersedia";
    emailSpan.textContent = data.email || "-";
    followingSpan.textContent = data.following ? Object.keys(data.following).length : 0;
    followersSpan.textContent = data.followers ? Object.keys(data.followers).length : 0;

    profileSection.classList.remove("hidden");
  } catch (error) {
    console.error("Gagal memuat profil:", error);
  }
}
</script>
<section class="mt-4 bg-white dark:bg-gray-900 p-4 border rounded" id="search-user-section">
<h2 class="text-lg font-semibold mb-2">üîç Cari Pengguna</h2>
<input class="border rounded px-2 py-1 w-full mb-2" id="search-username" placeholder="Masukkan username..." type="text"/>
<ul class="space-y-2 text-sm" id="search-results"></ul>
</section>
<script>
document.getElementById("search-username")?.addEventListener("input", async (e) => {
  const keyword = e.target.value.toLowerCase();
  const list = document.getElementById("search-results");
  list.innerHTML = "";

  if (keyword.length < 2) return;

  const snap = await get(dbRef(database, "users"));
  if (!snap.exists()) return;

  const users = snap.val();
  Object.entries(users).forEach(([uid, user]) => {
    if ((user.username || "").toLowerCase().includes(keyword)) {
      const li = document.createElement("li");
      li.className = "flex justify-between items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded";
      li.innerHTML = \`
        <span>\${user.username || user.email}</span>
        <button class="text-blue-600 text-xs hover:underline" onclick="viewUserProfile('\${uid}')">Lihat Profil</button>
      \`;
      list.appendChild(li);
    }
  });
});
</script><script>
let viewedUserId = null;
let currentUserId = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUserId = user.uid;
  }
});

async function viewUserProfile(uid) {
  viewedUserId = uid;
  const profileSection = document.getElementById("public-profile");
  const usernameSpan = document.getElementById("public-username");
  const emailSpan = document.getElementById("public-email");
  const followingSpan = document.getElementById("public-following-count");
  const followersSpan = document.getElementById("public-followers-count");
  const followBtn = document.getElementById("follow-button");

  try {
    const snap = await get(dbRef(database, "users/" + uid));
    if (!snap.exists()) {
      alert("Pengguna tidak ditemukan.");
      return;
    }

    const data = snap.val();
    usernameSpan.textContent = data.username || "Tidak tersedia";
    emailSpan.textContent = data.email || "-";
    followingSpan.textContent = data.following ? Object.keys(data.following).length : 0;
    followersSpan.textContent = data.followers ? Object.keys(data.followers).length : 0;

    profileSection.classList.remove("hidden");

    if (currentUserId && currentUserId !== uid) {
      const followSnap = await get(dbRef(database, `users/${currentUserId}/following/${uid}`));
      followBtn.textContent = followSnap.exists() ? "Berhenti Mengikuti" : "Ikuti";
      followBtn.onclick = () => toggleFollow(uid, followSnap.exists());
    } else {
      followBtn.style.display = "none";
    }

  } catch (error) {
    console.error("Gagal memuat profil:", error);
  }
}

async function toggleFollow(targetUid, isFollowing) {
  const updates = {};
  if (isFollowing) {
    updates[`users/${currentUserId}/following/${targetUid}`] = null;
    updates[`users/${targetUid}/followers/${currentUserId}`] = null;
  } else {
    updates[`users/${currentUserId}/following/${targetUid}`] = true;
    updates[`users/${targetUid}/followers/${currentUserId}`] = true;
  }

  try {
    await update(dbRef(database), updates);
    viewUserProfile(targetUid); // refresh profil
  } catch (error) {
    console.error("Gagal update follow:", error);
  }
}
</script><script>
async function loadUserContent(uid) {
  const contentBox = document.getElementById("user-content-section");
  const contentList = document.getElementById("user-content-list");
  contentList.innerHTML = "";
  contentBox.classList.add("hidden");

  const contentSnap = await get(dbRef(database, "content/" + uid));
  if (!contentSnap.exists()) return;

  const content = contentSnap.val();
  Object.values(content).forEach(item => {
    const div = document.createElement("div");
    div.className = "bg-gray-200 dark:bg-gray-800 p-2 rounded";
    if (item.type === "image") {
      div.innerHTML = `<img src="\${item.url}" alt="Image" class="w-full h-auto rounded">`;
    } else if (item.type === "video") {
      div.innerHTML = \`
        <video controls class="w-full h-auto rounded">
          <source src="\${item.url}" type="video/mp4">
        </video>\`;
    }
    contentList.appendChild(div);
  });

  contentBox.classList.remove("hidden");
}

// Panggil juga saat melihat profil
async function viewUserProfile(uid) {
  viewedUserId = uid;
  const profileSection = document.getElementById("public-profile");
  const usernameSpan = document.getElementById("public-username");
  const emailSpan = document.getElementById("public-email");
  const followingSpan = document.getElementById("public-following-count");
  const followersSpan = document.getElementById("public-followers-count");
  const followBtn = document.getElementById("follow-button");

  try {
    const snap = await get(dbRef(database, "users/" + uid));
    if (!snap.exists()) {
      alert("Pengguna tidak ditemukan.");
      return;
    }

    const data = snap.val();
    usernameSpan.textContent = data.username || "Tidak tersedia";
    emailSpan.textContent = data.email || "-";
    followingSpan.textContent = data.following ? Object.keys(data.following).length : 0;
    followersSpan.textContent = data.followers ? Object.keys(data.followers).length : 0;

    profileSection.classList.remove("hidden");

    if (currentUserId && currentUserId !== uid) {
      const followSnap = await get(dbRef(database, `users/${currentUserId}/following/${uid}`));
      followBtn.textContent = followSnap.exists() ? "Berhenti Mengikuti" : "Ikuti";
      followBtn.style.display = "inline-block";
      followBtn.onclick = () => toggleFollow(uid, followSnap.exists());
    } else {
      followBtn.style.display = "none";
    }

    loadUserContent(uid);

  } catch (error) {
    console.error("Gagal memuat profil:", error);
  }
}
</script><script>
const OWNER_EMAILS = [
  "alarifkyhp@gmail.com",
  "hasbullahbeloh27@gmail.com"
];
const ADMIN_EMAILS = [...OWNER_EMAILS];

function isAdmin(email) {
  return ADMIN_EMAILS.includes(email);
}
function isOwner(email) {
  return OWNER_EMAILS.includes(email);
}

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUserId = user.uid;
    const email = user.email;
    const isOwnerAccount = isOwner(email);

    if (isAdmin(email)) {
      const panel = document.getElementById("admin-panel");
      if (panel) panel.classList.remove("hidden");
    }

    // Auto assign role if owner and not yet defined
    const userRef = dbRef(database, "users/" + user.uid);
    get(userRef).then(snap => {
      if (snap.exists()) {
        const data = snap.val();
        if (!data.role && isOwnerAccount) {
          update(userRef, { role: "Owner" });
        }
      }
    });
  }
});
</script><script>
async function loadUserRoles() {
  const snap = await get(dbRef(database, "users"));
  const list = document.getElementById("user-role-list");
  list.innerHTML = "";
  if (!snap.exists()) return;

  const users = snap.val();
  Object.entries(users).forEach(([uid, data]) => {
    const currentRole = data.role || (OWNER_EMAILS.includes(data.email) ? "Owner" : "User");
    const isOwner = currentRole === "Owner";
    const roleLabel = isOwner ? '<span class="ml-2 text-red-600 font-semibold text-xs">[Owner]</span>' : '';
    const li = document.createElement("li");
    li.className = "flex items-center justify-between border-b py-2";
    li.innerHTML = \`
      <span>\${data.username || data.email} \${roleLabel}</span>
      <select onchange="updateUserRole('\${uid}', this.value)" \${isOwner ? 'disabled' : ''} class="border px-1 py-0.5 text-sm rounded">
        <option value="User" \${currentRole === "User" ? 'selected' : ''}>User</option>
        <option value="Moderator" \${currentRole === "Moderator" ? 'selected' : ''}>Moderator</option>
        <option value="Admin" \${currentRole === "Admin" ? 'selected' : ''}>Admin</option>
        <option value="Owner" \${currentRole === "Owner" ? 'selected' : ''}>Owner</option>
      </select>
    \`;
    list.appendChild(li);
  });
}
</script><script>
let chatListener = null;
let activeChatUID = null;

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

async function openPrivateChat(uid) {
  const chatBox = document.getElementById("private-chat-box");
  const msgContainer = document.getElementById("chat-messages");
  const input = document.getElementById("chat-input");
  const sendBtn = document.getElementById("chat-send-btn");

  if (!chatBox || !msgContainer || !input || !sendBtn || !currentUserId || !uid) return;

  activeChatUID = uid;
  chatBox.classList.remove("hidden");
  msgContainer.innerHTML = "";

  if (chatListener) chatListener(); // Remove previous listener

  const chatId = currentUserId < uid ? currentUserId + "_" + uid : uid + "_" + currentUserId;
  const chatRef = dbRef(database, "private_chats/" + chatId);

  chatListener = onValue(chatRef, (snapshot) => {
    msgContainer.innerHTML = "";
    if (!snapshot.exists()) return;

    const messages = Object.values(snapshot.val()).sort((a, b) => a.timestamp - b.timestamp);
    messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "mb-2 p-2 rounded " + (msg.from === currentUserId ? "bg-blue-100" : "bg-gray-200");
      div.innerHTML = \`
        <div class="text-xs text-gray-600">\${msg.from === currentUserId ? "Anda" : "Dia"} ‚Ä¢ \${formatTime(msg.timestamp)}</div>
        <div>\${msg.text}</div>
      \`;
      msgContainer.appendChild(div);
    });

    msgContainer.scrollTop = msgContainer.scrollHeight;
  });

  sendBtn.onclick = async () => {
    const text = input.value.trim();
    if (!text) return;

    const newMsgRef = push(dbRef(database, "private_chats/" + chatId));
    await set(newMsgRef, {
      from: currentUserId,
      to: activeChatUID,
      text,
      timestamp: Date.now()
    });

    input.value = "";
  };

  input.onkeydown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendBtn.click();
    }
  };
}

const originalViewUserProfile = viewUserProfile;
viewUserProfile = async function(uid) {
  await originalViewUserProfile(uid);
  if (uid !== currentUserId) {
    openPrivateChat(uid);
  }
};
</script></body>
</html>
